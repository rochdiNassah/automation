#!/usr/bin/env php
<?php declare(strict_types=1);

require './vendor/autoload.php';

use Automation\Framework\Application;
use Automation\Framework\Facades\Slack;
use Automation\Framework\Queue\Queueable;
use App\Jobs\CheckHackeronePrograms;

Application::instance()->run();

$sleep_for = (int) config('DAEMON_SLEEP_FOR');

if (false === ($message = Slack::channel('debug')->send('Automation daemon has started!'))) {
    throw new Exception('Unable to notify that the daemon has started!');
}

sleep(4);

Slack::delete($message);

app()->resolve(CheckHackeronePrograms::class);

$jobs = app()->getInstancesOf(Queueable::class);

while (true) {
    foreach ($jobs as $job) {
        app([$job, 'execute']);
    }

    sleep(4);
}